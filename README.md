# A Demo of Reliable Distributed System

[![Build Status](https://travis-ci.org/dwyl/esta.svg?branch=master)]()

## Protocol
 
 ### Input
 
Currently support input in client `var=value`, an `id` will be automatically generated by protocol.

### Communication Between Server and Client

#### Request

`val=value` will be packed in the following form

```
client_id#server_id#request_id#var#value
``` 

and then send to server. 

Server will unpack it to `var` and `value` and store it in database.

#### Respond

A Respond will be send from server to client indicating that server has received msg. The respond will look like

```$xslt
client_id#server_id#request_id#data_in_server_database
```

### Communication between LFD and GFD

LFD and GFD are communicate in a similar protocol, where the msg looks like

```$xslt
LFD_id#operation#server_id
```
`operation` could be either `add` or `delete`, indicating the status change of a server from dead to alive or alive to dead.

## Database

Currently a naive `hashmap<String, String>`.

## Local Fault Detector and Global Fault Detector

### LFD (Local Fault Detector)

LFD will keep pinging server to determine whether it is alive. When server is dead, it will report to the GFD that server is no longer available, when server is back online, it will also report to the GFD.

### GFD (Global Fault Detector)

The GFD will maintain a database (currently the a hash set) about the availability of servers. Message from LFD will be handled to determine whether a server is available anymore.

## Active Replication

### Server

Clients connect to all the servers, server updates when receive messages from clients.

### When server down

When server is down, the LFD will detect it by heart beating and report it to GFD to delete the membership. Also, GFD will send a message to replica manager.

### Recovery

When new server is back, LFD will detect it by heartbeats and report it to GFD to update membership. Replica manager will also receive the update of the new server from GFD.

Then, replica manager will send a message to one of severs to send the checkpointing to the new sever to finish recovery.

### Duplicate Detection

We have a way of ensuring that replicas do not perform duplicate operations multiple times.

When clients receive messages from servers, we will check request ID in replies to deduplicate the messages from servers.



## RM
The replica manager is a subsystem that is responsible for managing the synchronization of replicas. The replica manager is responsible for the following:

Maintaining and updating memberships

Designating new primary in passive mode

Updating the newly added server in active replication by asking one server to send checkpointing message to the new server.

## Passive Replication

### Server

Clients connect to all the servers, server updates when receive messages from clients.

Also, primary server sends checkpointing messages to back up servers at certain frequency.

### Duplicate Detection

Same to active replication in order to avoid duplicate operations multiple times. 

### When primary server down

When primary server is down, the LFD will detect it by heart beating and report it to GFD to delete the membership. Also, GFD will send a message to replica manager.

Replica manager will designate a new primary replica chosen from backup servers.


### Recovery

When new server(backup server) is back, LFD will detect it by heartbeats and report it to GFD to update membership. Replica manager will also receive the update of the new server from GFD.

The new backup server will be updated when receiving the checkpointing message.

## Usage

How to launch each program

### Server

`java Server <Server id> <port number> (<primary or backup or recover>) (option: p for primary, b for back up))`

i.e.

`java Server 0 8888 p` stands for launching server 0 in passive replication mode as primary listening port 8888.

`java Server 0 8888` stands for launching server 0 in active replication  mode listening port 8888.

`java Server 0 8888 r` stands for launching server 0 as recovery in active replication  mode listening port 8888. (In passive replication  mode, launch a backup server 0 directly).

### LFD

`java LFD <LFD id> <host name> <serverID> <time out> (<heartbeat freq>)`



`java LFD 0 127.0.0.1 0 2000 1000`  stands for launching LFD 0 for heartbeating server 0 with the hostname 127.0.0.1.

The time for time out is 2000ms and heartbeat frequency is 1000.(The default heartbeat freq is 2000, which is optional.)

### GFD

`java GFD <port number>(Default: 8891)`
 
i.e.

`java GFD 8891`stands for launching GFD as listening port 8891.


### Replica Manager

`java ReplicaManager passive/active`

i.e.

`java ReplicaManager passive`stands for launching replica manager in passive replication mode.

`java ReplicaManager active`stands for launching replica manager in active replication mode.

### Client

`java Client <client id> <host name> <serverID 1> <severID 2> <serverID 3> `

i.e.

`java Client 0 127.0.0.1 0 1 2` stands for launching client 0 with the hostname 127.0.0.1 and connect to server 0, server 1 and server 2.




